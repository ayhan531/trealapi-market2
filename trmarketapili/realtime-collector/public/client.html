<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÔøΩ Stocks Market - Canlƒ± Fiyatlar</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 30px 20px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        margin-bottom: 40px;
        text-align: center;
      }
      h1 {
        font-size: 36px;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
      }
      .status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 14px;
        color: #666;
      }
      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #48bb78;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .products-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        padding: 0;
      }
      .product-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }
      .product-card:hover {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      }
      .product-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }
      .product-title {
        font-size: 18px;
        font-weight: 700;
        color: #1a202c;
      }
      .product-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        font-weight: 600;
        padding: 6px 14px;
        border-radius: 20px;
        background: #f0f4ff;
        color: #667eea;
      }
      .product-status.closed {
        background: #ffe0e0;
        color: #e53e3e;
      }
      .status-dot-product {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 1.5s infinite;
      }
      .product-status.closed .status-dot-product {
        animation: none;
      }
      .product-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 18px;
        font-size: 12px;
      }
      .info-item {
        display: flex;
        flex-direction: column;
      }
      .info-label {
        font-size: 10px;
        color: #999;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .info-value {
        font-size: 13px;
        font-weight: 700;
        color: #1a202c;
      }
      .variants-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
      }
      .variant-item {
        display: grid;
        grid-template-columns: 70px 1fr auto auto;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 10px;
        border-left: 3px solid #667eea;
        font-size: 12px;
      }
      .variant-name {
        font-weight: 700;
        color: #1a202c;
        font-size: 13px;
      }
      .variant-desc {
        font-size: 11px;
        color: #999;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .variant-price {
        font-weight: 700;
        color: #1a202c;
        text-align: right;
      }
      .variant-change {
        text-align: right;
        min-width: 60px;
        font-weight: 600;
      }
      .variant-change.positive {
        color: #48bb78;
      }
      .variant-change.negative {
        color: #e53e3e;
      }
      .variant-change.neutral {
        color: #999;
      }
      .no-data {
        text-align: center;
        padding: 20px;
        color: #999;
        font-size: 13px;
      }
      .product-category {
        font-size: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-weight: 600;
      }
      .loader {
        text-align: center;
        padding: 60px 20px;
        font-size: 18px;
        color: white;
      }
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .last-update {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 12px;
        margin-top: 30px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üìà Stocks Market</h1>
        <p style="color: #666; margin-bottom: 15px; font-size: 16px">
          27 √úr√ºn - Canlƒ± Fiyatlar
        </p>
        <div class="status">
          <div class="status-dot"></div>
          <span id="statusText">Baƒülanƒ±lƒ±yor...</span>
        </div>
      </header>
      <div class="products-container" id="productsContainer">
        <div class="loader">
          <div class="spinner"></div>
          <p>Fiyatlar y√ºkleniyor...</p>
        </div>
      </div>
      <div class="last-update">
        <p>Son G√ºncelleme: <span id="lastUpdate">--:--:--</span></p>
      </div>
    </div>
    <script>
      const container = document.getElementById("productsContainer");
      const statusText = document.getElementById("statusText");
      const lastUpdateSpan = document.getElementById("lastUpdate");
      let allStocks = {};
      let connected = false;
      const products = [
        {
          id: "VSE",
          name: "Vienna",
          country: "Avusturya",
          currency: "EUR",
          hours: "10:04-18:30",
          utcOffset: 1,
        },
        {
          id: "DFM",
          name: "Dubai",
          country: "B.A.E",
          currency: "AED",
          hours: "09:00-13:00",
          utcOffset: 4,
        },
        {
          id: "BHX",
          name: "Bahrain",
          country: "Bahreyn",
          currency: "BHD",
          hours: "09:30-12:30",
          utcOffset: 3,
        },
        {
          id: "ENXBE",
          name: "Brussels",
          country: "Bel√ßika",
          currency: "EUR",
          hours: "10:00-18:30",
          utcOffset: 1,
        },
        {
          id: "PSE",
          name: "Prague",
          country: "√áekya",
          currency: "CZK",
          hours: "10:00-17:20",
          utcOffset: 1,
        },
        {
          id: "CSE",
          name: "Copenhagen",
          country: "Danimarka",
          currency: "DKK",
          hours: "10:00-18:00",
          utcOffset: 1,
        },
        {
          id: "HEX",
          name: "Helsinki",
          country: "Finlandiya",
          currency: "EUR",
          hours: "10:00-18:30",
          utcOffset: 2,
        },
        {
          id: "ENXPA",
          name: "Paris",
          country: "Fransa",
          currency: "EUR",
          hours: "10:00-18:30",
          utcOffset: 1,
        },
        {
          id: "JSE",
          name: "Johannesburg",
          country: "G.Afrika",
          currency: "ZAR",
          hours: "10:00-17:00",
          utcOffset: 2,
        },
        {
          id: "ENXAM",
          name: "Amsterdam",
          country: "Hollanda",
          currency: "EUR",
          hours: "10:00-18:30",
          utcOffset: 1,
        },
        {
          id: "LSE",
          name: "London",
          country: "ƒ∞ngiltere",
          currency: "GBP",
          hours: "10:00-18:30",
          utcOffset: 0,
        },
        {
          id: "ENXDU",
          name: "Dublin",
          country: "ƒ∞rlanda",
          currency: "EUR",
          hours: "10:00-18:30",
          utcOffset: 0,
        },
        {
          id: "BME",
          name: "Madrid",
          country: "ƒ∞spanya",
          currency: "EUR",
          hours: "10:00-18:30",
          utcOffset: 1,
        },
        {
          id: "OMXS",
          name: "Stockholm",
          country: "ƒ∞sve√ß",
          currency: "SEK",
          hours: "10:00-18:30",
          utcOffset: 1,
        },
        {
          id: "SIX",
          name: "Zurich",
          country: "ƒ∞svi√ßre",
          currency: "CHF",
          hours: "10:00-18:20",
          utcOffset: 1,
        },
        {
          id: "MIL",
          name: "Milano",
          country: "ƒ∞talya",
          currency: "EUR",
          hours: "10:00-18:30",
          utcOffset: 1,
        },
        {
          id: "QE",
          name: "Qatar",
          country: "Katar",
          currency: "QAR",
          hours: "09:30-13:00",
          utcOffset: 3,
        },
        {
          id: "KSE",
          name: "Kuwait",
          country: "Kuveyt",
          currency: "KWD",
          hours: "09:00-12:30",
          utcOffset: 3,
        },
        {
          id: "BES",
          name: "Budapest",
          country: "Macaristan",
          currency: "HUF",
          hours: "10:00-18:00",
          utcOffset: 1,
        },
        {
          id: "EGX",
          name: "Kahire",
          country: "Mƒ±sƒ±r",
          currency: "EGP",
          hours: "11:00-15:30",
          utcOffset: 2,
        },
        {
          id: "OBX",
          name: "Oslo",
          country: "Norve√ß",
          currency: "NOK",
          hours: "10:00-17:30",
          utcOffset: 1,
        },
        {
          id: "MSM",
          name: "Muscat",
          country: "Oman",
          currency: "OMR",
          hours: "09:00-13:00",
          utcOffset: 4,
        },
        {
          id: "GPW",
          name: "Var≈üova",
          country: "Polonya",
          currency: "PLN",
          hours: "10:00-17:50",
          utcOffset: 1,
        },
        {
          id: "ENXLI",
          name: "Lisbon",
          country: "Portekiz",
          currency: "EUR",
          hours: "10:00-18:30",
          utcOffset: 0,
        },
        {
          id: "TASI",
          name: "Riyad",
          country: "S.Arabistan",
          currency: "SAT",
          hours: "10:00-15:00",
          utcOffset: 3,
        },
        {
          id: "ATHEX",
          name: "Atina",
          country: "Yunanistan",
          currency: "EUR",
          hours: "10:30-17:00",
          utcOffset: 2,
        },
        {
          id: "XETRA",
          name: "Berlin",
          country: "Almanya",
          currency: "EUR",
          hours: "09:00-17:30",
          utcOffset: 1,
        },
        {
          id: "STO",
          name: "Stockholm2",
          country: "ƒ∞sve√ß",
          currency: "SEK",
          hours: "09:00-17:30",
          utcOffset: 1,
        },
      ];

      function isActive(product) {
        const now = new Date();
        const localHour = now.getUTCHours() + product.utcOffset;
        const [startStr, endStr] = product.hours.split("-");
        const times = [startStr, endStr].map((t) => t.split(":").map(Number));
        const startMin = times[0][0] * 60 + times[0][1];
        const endMin = times[1][0] * 60 + times[1][1];
        const currentMin = (localHour % 24) * 60 + now.getMinutes();
        return (
          now.getUTCDay() >= 1 &&
          now.getUTCDay() <= 5 &&
          currentMin >= startMin &&
          currentMin < endMin
        );
      }

      function renderProducts() {
        let html = "";
        for (const product of products) {
          const stocks = allStocks[product.id] || [];
          const active = isActive(product);
          const variantsHtml =
            stocks.length > 0
              ? stocks
                  .map((stock) => {
                    const price = parseFloat(stock.price) || 0;
                    const priceInTL = parseFloat(stock.priceInTL) || 0;
                    const change = parseFloat(stock.change) || 0;
                    const changePct = parseFloat(stock.changePct) || 0;
                    const changeClass =
                      change > 0
                        ? "positive"
                        : change < 0
                          ? "negative"
                          : "neutral";
                    const sign = change > 0 ? "+" : "";
                    return `<div class="variant-item">
                      <div class="variant-name">${stock.symbol}</div>
                      <div><div class="variant-desc">${
                        stock.name || stock.symbol
                      }</div></div>
                      <div class="variant-price">
                        <span>${stock.currency}${price.toFixed(2)}</span>
                        <span style="font-size: 11px; color: #999; margin-left: 4px;">‚Ç∫${priceInTL.toFixed(0)}</span>
                      </div>
                      <div class="variant-change ${changeClass}">${sign}${changePct.toFixed(2)}%</div>
                    </div>`;
                  })
                  .join("")
              : '<div class="no-data">Fiyat y√ºkleniyor...</div>';

          html += `<div class="product-card">
            <div class="product-header">
              <div>
                <div class="product-title">üì¶ ${product.name}</div>
              </div>
              <div class="product-status ${active ? "" : "closed"}">
                <div class="status-dot-product"></div>
                <span>${active ? "A√áIK" : "KAPALI"}</span>
              </div>
            </div>
            <div class="product-info">
              <div class="info-item">
                <div class="info-label">Kategori</div>
                <div class="product-category">${product.country}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Para</div>
                <div class="info-value">${product.currency}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Saatler</div>
                <div class="info-value" style="font-size:12px">${product.hours}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Varyant</div>
                <div class="info-value">${stocks.length}</div>
              </div>
            </div>
            <div class="variants-list">
              ${variantsHtml}
            </div>
          </div>`;
        }
        container.innerHTML = html;
      }

      function updateTime() {
        const now = new Date();
        lastUpdateSpan.textContent =
          String(now.getHours()).padStart(2, "0") +
          ":" +
          String(now.getMinutes()).padStart(2, "0") +
          ":" +
          String(now.getSeconds()).padStart(2, "0");
      }

      function connectSSE() {
        const eventSource = new EventSource("/stream");

        eventSource.addEventListener("open", () => {
          connected = true;
          statusText.textContent = "Baƒülƒ± ‚úì";
        });

        eventSource.addEventListener("message", (event) => {
          try {
            const data = JSON.parse(event.data);
            updateTime();
            if (data.type === "intl_exchanges" && data.data) {
              allStocks = data.data;
              renderProducts();
            }
          } catch (error) {
            console.error("Parse error:", error);
          }
        });

        eventSource.addEventListener("error", () => {
          connected = false;
          statusText.textContent = "Baƒülantƒ± Kesildi ‚ö†Ô∏è";
          eventSource.close();
          setTimeout(connectSSE, 3000);
        });
      }

      renderProducts();
      updateTime();
      connectSSE();
      setInterval(updateTime, 1000);
      setInterval(renderProducts, 10000);
    </script>
  </body>
</html>
