<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; background:#0f172a; color:#e2e8f0; padding:24px; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; margin-bottom:16px; }
    h1 { font-size:22px; margin-bottom:16px; }
    h2 { font-size:18px; margin: 0 0 12px; }
    label { display:block; font-size:13px; margin:8px 0 6px; color:#94a3b8; }
    input, select { width:100%; padding:10px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; }
    button { background:#2563eb; border:none; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.danger { background:#ef4444; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #1f2937; font-size:14px; }
    .muted { color:#94a3b8; font-size:12px; }
    .status { font-size:14px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .green { background:#064e3b; color:#a7f3d0; }
    .yellow { background:#78350f; color:#fde68a; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>

  <div class="card">
    <h2>Akış Kontrol</h2>
    <div class="row">
      <div>
        <div class="status">Durum: <span id="pausedBadge" class="badge green">Çalışıyor</span></div>
        <div class="muted">Duraklatınca veri çekimi geçici olarak durur. Devam edince kaldığı yerden sürer.</div>
      </div>
      <div style="align-self:end;">
        <button id="togglePause">Duraklat</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Çekim Aralığı</h2>
    <div class="row">
      <div>
        <label>Güncelleme Aralığı (ms)</label>
        <input type="number" id="intervalMs" min="200" step="100" />
        <div class="muted">Borsa açıkken kullanılacak. Minimum 200ms.</div>
      </div>
      <div style="align-self:end;">
        <button id="saveInterval">Kaydet</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Fiyat Override</h2>
    <div class="row">
      <div>
        <label>Sembol (örn: BIST:ASELS)</label>
        <input id="ovSymbol" placeholder="BIST:XXXX" />
      </div>
      <div>
        <label>Tip</label>
        <select id="ovType">
          <option value="set">Set (direkt fiyat)</option>
          <option value="delta">Delta (ekle/çıkar)</option>
          <option value="percent">Percent (yüzde)</option>
        </select>
      </div>
      <div>
        <label>Değer</label>
        <input id="ovValue" type="number" step="0.0001" />
      </div>
      <div>
        <label>Süre (sn) - opsiyonel</label>
        <input id="ovDuration" type="number" min="1" step="1" placeholder="örn: 3600" />
        <div class="muted">Boş bırakılırsa kalıcı olur. Süre dolunca otomatik kalkar.</div>
      </div>
      <div style="align-self:end;">
        <button id="addOverride">Ekle/Güncelle</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Aktif Override'lar</h2>
    <table>
      <thead>
        <tr><th>Sembol</th><th>Tip</th><th>Değer</th><th>Bitiş</th><th></th></tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>

  <script>
    async function loadConfig() {
      const res = await fetch('/admin/api/config');
      const json = await res.json();
      document.getElementById('intervalMs').value = json.intervalMs ?? 1000;
      setPausedUi(!!json.paused);
      renderOverrides(json.overrides || {});
    }

    function setPausedUi(paused) {
      const badge = document.getElementById('pausedBadge');
      const btn = document.getElementById('togglePause');
      if (paused) {
        badge.textContent = 'Duraklatıldı';
        badge.className = 'badge yellow';
        btn.textContent = 'Devam Et';
      } else {
        badge.textContent = 'Çalışıyor';
        badge.className = 'badge green';
        btn.textContent = 'Duraklat';
      }
      btn.dataset.paused = String(paused);
    }

    function renderOverrides(ov) {
      const tbody = document.getElementById('list');
      tbody.innerHTML = '';
      const entries = Object.entries(ov);
      if (entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Kayıt yok</td></tr>';
        return;
      }
      for (const [symbol, v] of entries) {
        const tr = document.createElement('tr');
        let expiry = '';
        if (v.expiresAt) {
          const msLeft = Number(v.expiresAt) - Date.now();
          if (msLeft > 0) {
            const mins = Math.floor(msLeft / 60000);
            const secs = Math.floor((msLeft % 60000) / 1000);
            expiry = `${new Date(v.expiresAt).toLocaleString()} (kalan ${mins}dk ${secs}sn)`;
          } else {
            expiry = 'Süresi doldu (yakında kalkar)';
          }
        } else {
          expiry = 'Kalıcı';
        }
        tr.innerHTML = `<td>${symbol}</td><td>${v.type}</td><td>${v.value}</td><td>${expiry}</td>
          <td style="text-align:right;"><button class="danger" data-sym="${symbol}">Sil</button></td>`;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('button.danger').forEach(btn => {
        btn.addEventListener('click', async () => {
          const sym = btn.getAttribute('data-sym');
          if (!confirm(sym + ' override silinsin mi?')) return;
          await fetch('/admin/api/override/' + encodeURIComponent(sym), { method: 'DELETE' });
          loadConfig();
        });
      });
    }

    document.getElementById('saveInterval').addEventListener('click', async () => {
      const ms = Number(document.getElementById('intervalMs').value || 1000);
      await fetch('/admin/api/interval', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ intervalMs: ms })
      });
      alert('Kaydedildi');
    });

    document.getElementById('addOverride').addEventListener('click', async () => {
      const symbol = document.getElementById('ovSymbol').value.trim();
      const type = document.getElementById('ovType').value;
      const value = Number(document.getElementById('ovValue').value);
      const durationSec = Number(document.getElementById('ovDuration').value);
      if (!symbol) { alert('Sembol zorunlu'); return; }
      await fetch('/admin/api/override', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol, type, value, durationSec: Number.isFinite(durationSec) && durationSec > 0 ? durationSec : undefined })
      });
      document.getElementById('ovValue').value = '';
      document.getElementById('ovDuration').value = '';
      loadConfig();
    });

    document.getElementById('togglePause').addEventListener('click', async () => {
      const btn = document.getElementById('togglePause');
      const willPause = !(btn.dataset.paused === 'true');
      await fetch('/admin/api/pause', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paused: willPause })
      });
      setPausedUi(willPause);
    });

    loadConfig();
  </script>
</body>
</html>
